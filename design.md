# Web NFC API Test Design

## Introduction

This document is trying to design web platform tests for the
[Web NFC API](https://w3c.github.io/web-nfc/) specification.

The designed test cases are described by **test assertion** with proper
pre-/post-condition.

## Terms

Most of the terms are defined in W3C
[test methodology](http://www.w3.org/TR/test-methodology/) specification
which specifies a method for wirting testable conformance requirements.

* **Requirement** means conformance requirement of the API specification
  to be tested.
* **Test assertion** is a prose description of a test case intended for human
  testers - i.e., for a given test case, testable assertion defines exactly
  what the user agent needs to do (behaviorally or conditionally) to pass the
  test case. It is important to note that testable assertions don’t appear in
  a specification - they only appear in a test suite to describe a test case. 
* A **test case** is a machine processable object that is used to test one
  or more conformance requirements

## Test Design

### IDL to Test

**Requirement**: Implementations that use ECMAScript to implement the APIs
defined in this document MUST implement them in a manner consistent with the
ECMAScript Bindings defined in the
[Web IDL specification](http://www.w3.org/TR/WebIDL-1/),
as this document uses that specification and terminology.

**Test assertions**: Test that a user agent (UA) is a [conforming ECMAScript
implementation](https://heycam.github.io/webidl/#dfn-conforming-ecmascript-implementation).
To pass, the UA must pass all the tests automatically generated by
[idlharness.js](https://github.com/w3c/testharness.js/blob/master/idlharness.js),
based on the Web IDL fragments specified by the Web NFC specification
within `<pre class="idl">`.

Feel free to try the un-reviewed idlharness.js based tests for Web NFC API at
https://zqzhang.github.io/demo/idlharness/webnfc.html

**Issue #1**: As per https://www.chromium.org/developers/web-idl-interfaces,
though Web IDL in Blink is close to the standard, and the resulting bindings
use standard conventions to call Blink code, there are additional features to
specify implementation details, primarily Blink IDL extended attributes. This
will result in many failures of the idlharness.js based tests running on Chrome.
I am not sure whether the Web NFC API has same issue.

A possible solution to this issue is to extend the existing test cases in
[idl-NavigatorNFC.html](https://zqzhang.github.io/demo/webnfc/idl-NavigatorNFC.html)
and [idl-NFC.html](https://zqzhang.github.io/demo/webnfc/idl-NFC.html)
to check the Web IDL fragments with reference to the checkpoints in
idlharness.js; and then change to idlharness.js based tests after resolving
the issue.

**Issue #2**: The Web NFC API spec refers to http://www.w3.org/TR/WebIDL-1/,
a W3C Working Draft 04 August 2015, while the idlharness.js is always updating
with latest Editor's Draft https://heycam.github.io/webidl/. So there is a
potential issue here that the Web IDL spec development will make difference
among the API specification, API implementation and idlharness.js framework.

**Note**: There is a reference mismatch for the WebIDL specification. In
normative reference section, it is http://www.w3.org/TR/WebIDL-1/; while in
terminology and conventions section http://heycam.github.io/webidl/. Maybe
the spec editors can resolve this and the issue #2 together.

### Use Case and Example to Test

#### Reading an NFC tag

```js
// Reading an NFC tag containing a Web NFC message,
// when a web page using the Web NFC API is open and in focus. 
navigator.nfc.watch((message) => {
  // Test assertion: check that successfully read an NFC device.

  // Issue: seems it cannot get here if ndef.TNF is 6 (NFC Unchaged Type record)
  // or 7 (NFC Reserved Type record), surpose there is a tag with such record.
  // Then the watch doesn't take effect as it cannot read the NFC tag, right?
  // Or will it reject the promise?

  // Process massage here to check more.
  processMessage(message);
}).then(() => {
  // Added a watch.
  // Test assertion: check that navigator.nfc.watch() returns a promise.
}).catch((error) => {
  // Failed to add a watch.
  // Can further check the errors, e.g. SecurityError, NotSupportedError.
});

function processMessage(message) {
  // Test assertion: check that message is a dictionary of NFCMessage, etc.
  // https://w3c.github.io/web-nfc/#dom-nfcmessage

  for (let record of message.data) {
    // Test assertions: check that a certain type of record is read.
    // These assertions are useful for reading -> re-writing -> reading cases.

    // The record here shall be NDEF record parsed following
    // https://w3c.github.io/web-nfc/#dfn-parsing-ndef-record
    switch (record.recordType) {
      case "empty":
        // record.mediaType = ""
        break;
      case "text":
        // record.mediaType = "text/plain"
        // record.mediaType = "text/plain;lang=*"
        break;
      case "url":
        // record.mediaType = "text/plain"
        break;
      case "json":
        // record.mediaType = "application/*json"
        break;
      case "opaque":
        // record.mediaType = ndef.TYPE 
        // record.mediaType = "application/octet-stream"
        break;
      default:
        // The 4.8 step doesn't specify the `record.recordType`,
        // we can check the message.url here.
        // Maybe this is a spec bug because the 5 step says that only
        // If NFC@[[suspended]] is false and message.data is not empty,
        // run the dispatch NFC content steps given message.
        break;
    }
  }
}
```

```js
// Reading an NFC tag containing other than Web NFC message,
// when a web page using the Web NFC API is open and in focus.
// Does this mean the issue I mentioned above that ndef.TNF is
// 6 (NFC Unchaged Type record)
// or 7 (NFC Reserved Type record)?
```

```js
// Reading an NFC tag
// when no web site using the Web NFC API is open or in focus.
// Seems this use-case includes handling Window visibility and focus described
// at https://w3c.github.io/web-nfc/#handling-window-visibility-and-focus
// However the spec is not clear about what is to be expected.
// See https://w3c.github.io/web-nfc/#the-ndef-parsing-algorithm
// "If NFC@[[suspended]] is true, abort these steps."
```

**Pre-condition**: avaiable NFC tag and successfully tap simulation. The
`NFCWatchOptions` doesn't specify whether it is a tag or a peer.

**Notes**:

* Spec typo `NFC.watch(options, callback)` at
  https://w3c.github.io/web-nfc/#dom-nfc-watch; 
  should be `NFC.watch(callback, options)`.
* Spec typo "`MessageCallback`var>callback" at the 1.7 step
  https://w3c.github.io/web-nfc/#dfn-dispatch-nfc-content;
  should be `<code>MessageCallback</code> <var>callback</var>` in source file.
* Spec typo `"application/octet-stream` at the 4.9.2 step
  https://w3c.github.io/web-nfc/#dfn-parsing-ndef-record;
  miss a `"`.
* Spec error in Example 4 `case "string":`; should be `case "text":` per
  https://w3c.github.io/web-nfc/#the-nfcrecord-dictionary

#### Writing to an NFC tag

> The user opens a web page which can write an NFC tag.

> Note that an NFC write operation to an NFC tag always involves also a read
  operation.

```js
// Writing to an empty NFC tag.
// EXAMPLE 4: Read data from tag, and write to empty ones
navigator.nfc.watch((message) => {
  if (message.data[0].recordType == 'empty') {
    // Test assertion: check that an empty NFC tag is found.
    navigator.nfc.push({
      url: "/custom/path",
      data: [{ recordType: "text", data: 'Hello World' }]
    });
    // Test assertion: check that it is able to write to an empty NFC tag.
    // Test assertion: re-read the NFC tag and check that the message data is
    //                 the same one as pushed.
  } else {
    console.log('Read message written by ' + message.url);
    processMessage(message);
  }
}).then(() => {
  console.log("Added a watch.");
}).catch((error) => {
  console.log("Adding watch failed: " + error.name);
});
```

```js
// Writing to an NFC tag which already contains a Web NFC message with a
// different Web NFC message origin (i.e. overwriting a web-specific tag).
```

```js
// Writing to an NFC tag which already contains a Web NFC message with the same
// Web NFC message origin (i.e. updating own tag).
```

```js
// Writing to other, writable NFC tags (i.e. overwriting a generic tag).
```

#### Pushing data to an NFC peer device

> On the initiating device the user would first have to navigate to a web site.
  The user would then touch the device against another Web NFC equipped device,
  and data transfer would occur.

> On the receiving device the UA will dispatch the content to an application
  registered and eligible to handle the content, and if that application is a
  browser which has a web page open and in focus that uses the Web NFC API and
  has set up a NFC watch to listen to Web NFC content, then the content is
  delivered to the web page through the parameters of an NFCMessageCallback.

```js
```

### Parameter to Test


### Algorithm, Statement to Test


## References

* Dominique Hazael-Massieux, Marcos Caceres. A Method for Writing Testable
  Conformance Requirements. W3C Working Group Note 28 January 2010. URL:
  http://www.w3.org/TR/test-methodology/
* Kenneth Rohde Christiansen, Zoltan Kis. Web NFC API. Draft Community Group
  Report 13 November 2015. URL: https://w3c.github.io/web-nfc/
* Testing Web Bluetooth. Draft Community Group Report, 23 September 2015. URL:
  https://webbluetoothcg.github.io/web-bluetooth/tests/
